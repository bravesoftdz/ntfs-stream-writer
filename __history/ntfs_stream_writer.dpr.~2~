program ntfs_stream_writer;

{$APPTYPE CONSOLE}

uses
  SysUtils,
  windows;

function CopyFileI(source, dest:pchar):boolean;
var h,h2:integer;
mas:array[1..2048] of byte;
i:cardinal;
done:cardinal;
begin
result:=false;
h:=CreateFile(source,GENERIC_READ,FILE_SHARE_READ,nil,OPEN_EXISTING,0,0);
if h=-1 then exit;
h2:=CreateFile(dest,GENERIC_WRITE,FILE_SHARE_WRITE,nil,OPEN_ALWAYS,0,0);
while ReadFile(h,mas,sizeof(mas),done,nil) and(done<>0) do
WriteFile(h2,mas,done,i,nil);
CloseHandle(h);
CloseHandle(h2);
result:=true;
end;

var
s:string;
StreamName:string;
begin
if pos(StreamName,Paramstr(0))>0 then begin
Sleep(2000);
DeleteFile(PChar(Paramstr(1)));
MessageBox(0,'Killed',PChar(Paramstr(1)),mb_ok);
Exit;
end;
readln(s);
if s='kill_yourself' then
begin
s:=Paramstr(0)+StreamName;
if CopyFileI(PChar(Paramstr(0)),PChar(s)) then
begin
s:=s+' '+ParamStr(0);
WinExec(PChar(s),SW_SHOWDEFAULT);
end;
end;
end.
